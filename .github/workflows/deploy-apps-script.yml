name: Deploy Apps Script

on:
  push:
    branches: [ main ]
    paths:
      - 'apps-script-template.js'
      - 'appsscript.json'
  workflow_dispatch:  # μλ™ μ‹¤ν–‰λ„ κ°€λ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: μ €μ¥μ† μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v3
      
      - name: Node.js μ„¤μ •
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      
      - name: clasp μ„¤μΉ
        run: npm install -g @google/clasp
      
      - name: clasp μΈμ¦ μ„¤μ •
        env:
          CLASP_RC: ${{ secrets.CLASP_RC }}
        run: |
          if [ -z "$CLASP_RC" ]; then
            echo "β μ¤λ¥: CLASP_RC Secretμ΄ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤."
            echo "π“ μ„¤μ • λ°©λ²•μ€ README_CLASP.mdλ¥Ό μ°Έκ³ ν•μ„Έμ”."
            exit 1
          fi
          
          # .clasprc.json νμΌ μƒμ„± (λ‘ κ²½λ΅ λ¨λ‘ μƒμ„±ν•μ—¬ νΈν™μ„± ν™•λ³΄)
          # ν™ λ””λ ‰ν† λ¦¬ κ²½λ΅ (claspκ°€ λ¨Όμ € ν™•μΈν•λ” κ²½λ΅)
          echo "$CLASP_RC" > ~/.clasprc.json
          chmod 600 ~/.clasprc.json
          
          # .config/clasp κ²½λ΅ (ν‘μ¤€ κ²½λ΅)
          mkdir -p ~/.config/clasp
          echo "$CLASP_RC" > ~/.config/clasp/.clasprc.json
          chmod 600 ~/.config/clasp/.clasprc.json
          
          echo "β… clasp μΈμ¦ μ„¤μ • μ™„λ£"
      
      - name: Apps Script λ°°ν¬
        env:
          CLASP_SCRIPT_ID: ${{ secrets.CLASP_SCRIPT_ID }}
        run: |
          if [ -z "$CLASP_SCRIPT_ID" ]; then
            echo "β μ¤λ¥: CLASP_SCRIPT_ID Secretμ΄ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤."
            echo "π“ Apps Script ν”„λ΅μ νΈ μ„¤μ •μ—μ„ μ¤ν¬λ¦½νΈ IDλ¥Ό λ³µμ‚¬ν•μ„Έμ”."
            exit 1
          fi
          
          # .clasp.json μƒμ„±
          echo "{\"scriptId\":\"$CLASP_SCRIPT_ID\",\"rootDir\":\".\"}" > .clasp.json
          
          # .claspignore νμΌ ν™•μΈ
          if [ ! -f .claspignore ]; then
            echo "β οΈ .claspignore νμΌμ΄ μ—†μµλ‹λ‹¤. μƒμ„± μ¤‘..."
            echo "# Apps Script λ°°ν¬ μ‹ μ μ™Έν•  νμΌλ“¤
browser-test.js
browser-test-results.json
*.md
.git/
node_modules/" > .claspignore
          fi
          
          echo "π“¤ Apps Scriptμ— μ½”λ“ ν‘Έμ‹ μ¤‘..."
          clasp push --force
          
          echo "β… λ°°ν¬ μ™„λ£!"
      
      - name: λ°°ν¬ μ™„λ£ μ•λ¦Ό
        run: |
          echo "β… Apps Script μλ™ λ°°ν¬κ°€ μ™„λ£λμ—μµλ‹λ‹¤!"
          echo "π“‹ Apps Script νΈμ§‘κΈ°μ—μ„ λ³€κ²½μ‚¬ν•­μ„ ν™•μΈν•μ„Έμ”."

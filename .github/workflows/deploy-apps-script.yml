name: Deploy Apps Script

on:
  push:
    branches: [ main ]
    paths:
      - 'apps-script-template.js'
      - 'appsscript.json'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      
      - name: clasp ì„¤ì¹˜
        run: npm install -g @google/clasp
      
      - name: clasp ì¸ì¦ ì„¤ì •
        env:
          CLASP_RC: ${{ secrets.CLASP_RC }}
        run: |
          if [ -z "$CLASP_RC" ]; then
            echo "âŒ ì˜¤ë¥˜: CLASP_RC Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ðŸ“ ì„¤ì • ë°©ë²•ì€ README_CLASP.mdë¥¼ ì°¸ê³ í•˜ì„¸ìš”."
            exit 1
          fi
          
          # .clasprc.json íŒŒì¼ ìƒì„± (ë‘ ê²½ë¡œ ëª¨ë‘ ìƒì„±í•˜ì—¬ í˜¸í™˜ì„± í™•ë³´)
          # í™ˆ ë””ë ‰í† ë¦¬ ê²½ë¡œ (claspê°€ ë¨¼ì € í™•ì¸í•˜ëŠ” ê²½ë¡œ)
          echo "$CLASP_RC" > ~/.clasprc.json
          chmod 600 ~/.clasprc.json
          
          # .config/clasp ê²½ë¡œ (í‘œì¤€ ê²½ë¡œ)
          mkdir -p ~/.config/clasp
          echo "$CLASP_RC" > ~/.config/clasp/.clasprc.json
          chmod 600 ~/.config/clasp/.clasprc.json
          
          echo "âœ… clasp ì¸ì¦ ì„¤ì • ì™„ë£Œ"
      
      - name: Apps Script ë°°í¬
        env:
          CLASP_SCRIPT_ID: ${{ secrets.CLASP_SCRIPT_ID }}
        run: |
          if [ -z "$CLASP_SCRIPT_ID" ]; then
            echo "âŒ ì˜¤ë¥˜: CLASP_SCRIPT_ID Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ðŸ“ Apps Script í”„ë¡œì íŠ¸ ì„¤ì •ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ IDë¥¼ ë³µì‚¬í•˜ì„¸ìš”."
            exit 1
          fi
          
          # .clasp.json ìƒì„±
          echo "{\"scriptId\":\"$CLASP_SCRIPT_ID\",\"rootDir\":\".\"}" > .clasp.json
          
          # .claspignore íŒŒì¼ í™•ì¸
          if [ ! -f .claspignore ]; then
            echo "âš ï¸ .claspignore íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„± ì¤‘..."
            cat > .claspignore << 'EOF'
# Apps Script ë°°í¬ ì‹œ ì œì™¸í•  íŒŒì¼ë“¤
browser-test.js
browser-test-results.json
*.md
.git/
node_modules/
EOF
          fi
          
          echo "ðŸ“¤ Apps Scriptì— ì½”ë“œ í‘¸ì‹œ ì¤‘..."
          clasp push --force
          
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
      
      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "âœ… Apps Script ìžë™ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ðŸ“‹ Apps Script íŽ¸ì§‘ê¸°ì—ì„œ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”."

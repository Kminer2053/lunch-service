name: Deploy Apps Script

on:
  push:
    branches: [ main ]
    paths:
      - 'apps-script-template.js'
      - 'appsscript.json'
      - '.github/workflows/deploy-apps-script.yml'  # μ›ν¬ν”λ΅μ° νμΌ λ³€κ²½ μ‹μ—λ„ μ‹¤ν–‰
  workflow_dispatch:  # μλ™ μ‹¤ν–‰λ„ κ°€λ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: μ €μ¥μ† μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v3
      
      - name: Node.js μ„¤μ •
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      
      - name: clasp μ„¤μΉ
        run: npm install -g @google/clasp
      
      - name: clasp μΈμ¦ μ„¤μ •
        env:
          CLASP_RC: ${{ secrets.CLASP_RC }}
        run: |
          if [ -z "$CLASP_RC" ]; then
            echo "β μ¤λ¥: CLASP_RC Secretμ΄ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤."
            echo "π“ μ„¤μ • λ°©λ²•μ€ README_CLASP.mdλ¥Ό μ°Έκ³ ν•μ„Έμ”."
            exit 1
          fi
          
          # .clasprc.json νμΌ μƒμ„± (λ‘ κ²½λ΅ λ¨λ‘ μƒμ„±ν•μ—¬ νΈν™μ„± ν™•λ³΄)
          # ν™ λ””λ ‰ν† λ¦¬ κ²½λ΅ (claspκ°€ λ¨Όμ € ν™•μΈν•λ” κ²½λ΅)
          echo "$CLASP_RC" > ~/.clasprc.json
          chmod 600 ~/.clasprc.json
          
          # .config/clasp κ²½λ΅ (ν‘μ¤€ κ²½λ΅)
          mkdir -p ~/.config/clasp
          echo "$CLASP_RC" > ~/.config/clasp/.clasprc.json
          chmod 600 ~/.config/clasp/.clasprc.json
          
          echo "β… clasp μΈμ¦ μ„¤μ • μ™„λ£"
      
      - name: Apps Script λ°°ν¬
        env:
          CLASP_SCRIPT_ID: ${{ secrets.CLASP_SCRIPT_ID }}
          CLASP_DEPLOYMENT_ID: ${{ secrets.CLASP_DEPLOYMENT_ID }}
        run: |
          if [ -z "$CLASP_SCRIPT_ID" ]; then
            echo "β μ¤λ¥: CLASP_SCRIPT_ID Secretμ΄ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤."
            echo "π“ Apps Script ν”„λ΅μ νΈ μ„¤μ •μ—μ„ μ¤ν¬λ¦½νΈ IDλ¥Ό λ³µμ‚¬ν•μ„Έμ”."
            exit 1
          fi
          
          # .clasp.json μƒμ„±
          echo "{\"scriptId\":\"$CLASP_SCRIPT_ID\",\"rootDir\":\".\"}" > .clasp.json
          
          # .claspignore νμΌ ν™•μΈ (λ¦¬ν¬μ§€ν† λ¦¬μ— ν¬ν•¨λμ–΄ μμ)
          if [ -f .claspignore ]; then
            echo "β… .claspignore νμΌ ν™•μΈλ¨"
            cat .claspignore
          else
            echo "β οΈ .claspignore νμΌμ΄ μ—†μµλ‹λ‹¤."
          fi
          
          echo "π“¤ Apps Scriptμ— μ½”λ“ ν‘Έμ‹ μ¤‘..."
          clasp push --force
          
          echo "π“¦ μƒ λ²„μ „ μƒμ„± μ¤‘..."
          VERSION_DESCRIPTION="Auto-deploy $(date +'%Y-%m-%d %H:%M:%S')"
          clasp version "$VERSION_DESCRIPTION"
          
          echo "π€ μ›Ή μ•± λ°°ν¬ μ¤‘..."
          if [ -z "$CLASP_DEPLOYMENT_ID" ]; then
            echo "β οΈ CLASP_DEPLOYMENT_IDκ°€ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤. μƒ λ°°ν¬λ¥Ό μƒμ„±ν•©λ‹λ‹¤."
            DEPLOYMENT_OUTPUT=$(clasp deploy --description "$VERSION_DESCRIPTION" 2>&1)
            echo "$DEPLOYMENT_OUTPUT"
            
            # λ°°ν¬ ID μ¶”μ¶
            DEPLOYMENT_ID=$(echo "$DEPLOYMENT_OUTPUT" | grep -oP 'Deployed \K[^\s]+' | head -1 || echo "")
            if [ -n "$DEPLOYMENT_ID" ]; then
              echo "π“‹ μƒ Deployment ID: $DEPLOYMENT_ID"
              echo "π’΅ μ΄ IDλ¥Ό GitHub Secretsμ CLASP_DEPLOYMENT_IDμ— μ €μ¥ν•λ©΄ λ‹¤μ λ°°ν¬λ¶€ν„° μλ™ μ—…λ°μ΄νΈλ©λ‹λ‹¤."
              
              # λ°°ν¬ URL κµ¬μ„± (μ¤ν¬λ¦½νΈ IDμ™€ λ°°ν¬ ID μ‚¬μ©)
              DEPLOYMENT_URL="https://script.google.com/macros/s/$CLASP_SCRIPT_ID/exec"
              echo "β… λ°°ν¬ URL: $DEPLOYMENT_URL"
              echo "π’΅ Renderμ GOOGLE_APPS_SCRIPT_URL ν™κ²½λ³€μκ°€ μ΄ URLκ³Ό μΌμΉν•λ”μ§€ ν™•μΈν•μ„Έμ”."
            else
              # λ°°ν¬ IDλ¥Ό μ°Ύμ§€ λ»ν• κ²½μ°μ—λ„ URL κµ¬μ„± μ‹λ„
              DEPLOYMENT_URL="https://script.google.com/macros/s/$CLASP_SCRIPT_ID/exec"
              echo "β οΈ λ°°ν¬ IDλ¥Ό μ¶”μ¶ν•μ§€ λ»ν–μ§€λ§, κΈ°λ³Έ λ°°ν¬ URL: $DEPLOYMENT_URL"
              echo "π’΅ Renderμ GOOGLE_APPS_SCRIPT_URL ν™κ²½λ³€μκ°€ μ΄ URLκ³Ό μΌμΉν•λ”μ§€ ν™•μΈν•μ„Έμ”."
            fi
          else
            echo "π”„ κΈ°μ΅΄ λ°°ν¬ μ—…λ°μ΄νΈ μ¤‘ (Deployment ID: ${CLASP_DEPLOYMENT_ID:0:10}...)"
            DEPLOYMENT_OUTPUT=$(clasp deploy --deploymentId "$CLASP_DEPLOYMENT_ID" --description "$VERSION_DESCRIPTION" 2>&1)
            echo "$DEPLOYMENT_OUTPUT"
            
            # λ°°ν¬ URL κµ¬μ„±
            DEPLOYMENT_URL="https://script.google.com/macros/s/$CLASP_SCRIPT_ID/exec"
            echo "β… λ°°ν¬ URL: $DEPLOYMENT_URL"
            echo "π’΅ Renderμ GOOGLE_APPS_SCRIPT_URL ν™κ²½λ³€μκ°€ μ΄ URLκ³Ό μΌμΉν•λ”μ§€ ν™•μΈν•μ„Έμ”."
          fi
          
          # λ°°ν¬ λ©λ΅ ν™•μΈ (λ””λ²„κΉ…μ©)
          echo ""
          echo "π“‹ ν„μ¬ λ°°ν¬ λ©λ΅:"
          clasp deployments 2>&1 | head -10 || echo "λ°°ν¬ λ©λ΅ μ΅°ν μ‹¤ν¨"
          
          echo "β… λ°°ν¬ μ™„λ£!"
      
      - name: λ°°ν¬ μ™„λ£ μ•λ¦Ό
        run: |
          echo "β… Apps Script μλ™ λ°°ν¬κ°€ μ™„λ£λμ—μµλ‹λ‹¤!"
          echo "π“‹ Apps Script νΈμ§‘κΈ°μ—μ„ λ³€κ²½μ‚¬ν•­μ„ ν™•μΈν•μ„Έμ”."
